name: Scheduled Calendar Sync

on:
  schedule:
    # ä¿æŒåŸæœ‰çš„å¿ƒè·³é¢‘ç‡ï¼Œç¡®ä¿æ—¥å†å’Œ Git ç»å¸¸åŒæ­¥
    # æ™¨åŒæ­¥: åŒ—äº¬ 08:30 -> UTC 00:30
    - cron: '30 0 * * *'
    # åˆåŒæ­¥: åŒ—äº¬ 13:30 -> UTC 05:30
    - cron: '30 5 * * *'
    # æ™šåŒæ­¥: åŒ—äº¬ 21:00 -> UTC 13:00
    - cron: '0 13 * * *'
  
  # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘
  workflow_dispatch:

# ğŸŸ¢ å¿…é¡»æœ‰å†™æƒé™ï¼Œå› ä¸º Prune ä¼šä¿®æ”¹æ–‡ä»¶
permissions:
  contents: write

jobs:
  sync_and_prune:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Sync to Feishu Calendar
        env:
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_USER_ID: ${{ secrets.FEISHU_USER_ID }}
          FEISHU_CALENDAR_ID: ${{ secrets.FEISHU_CALENDAR_ID }}
        run: |
          # æ‰§è¡ŒåŒæ­¥é€»è¾‘ (åŒ…å«è‡ªåŠ¨ä¿®å‰ªè¿‡æœŸæ•°æ®)
          python3 scripts/feishu_bot.py sync

      - name: Commit Pruned Data
        # å¦‚æœ Prune åˆ é™¤äº†æ—§æ•°æ®ï¼ŒGit ä¼šæ£€æµ‹åˆ°å˜æ›´ï¼Œæˆ‘ä»¬éœ€è¦æäº¤è¿™äº›å˜æ›´
        run: |
          git config --global user.name "LifeOps Bot"
          git config --global user.email "bot@lifeops.ai"
          
          if [[ -n $(git status -s data/schedule.json) ]]; then
            git add data/schedule.json
            git commit -m "ğŸ§¹ Auto-Pruned Old Schedule Data"
            git push
            echo "âœ… Pruned data committed."
          else
            echo "â„¹ï¸ No data needed pruning."
          fi
