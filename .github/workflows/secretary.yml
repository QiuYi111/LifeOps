name: LifeOps Secretary (Stateful & Auto-Fix)

on:
  repository_dispatch:
    types: [feishu_trigger]
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  manage_schedule:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialize Environment
        run: |
          mkdir -p ~/.claude
          cat <<EOF > ~/.claude/settings.json
          {
              "env": {
                  "ANTHROPIC_AUTH_TOKEN": "${{ secrets.ZHIPU_API_KEY }}",
                  "ANTHROPIC_BASE_URL": "https://open.bigmodel.cn/api/anthropic",
                  "API_TIMEOUT_MS": "3000000",
                  "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": "1"
              }
          }
          EOF
          mkdir -p data
          # ç¡®ä¿å…³é”®æ–‡ä»¶å­˜åœ¨
          if [ ! -f data/schedule.json ]; then echo "[]" > data/schedule.json; fi
          # ğŸŸ¢ å¦‚æœçŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„ï¼Œæˆ–è€…å¤åˆ¶ schedule.json (é¿å…é¦–æ¬¡é£æš´)
          if [ ! -f data/last_sync_state.json ]; then 
             echo "âš ï¸ State file missing. Creating from current schedule to avoid re-invite storm."
             cp data/schedule.json data/last_sync_state.json
          fi
          
          chmod -R 777 data
          sudo timedatectl set-timezone Asia/Shanghai
          pip install -r requirements.txt

      - name: Install & Run Claude (With Auto-Fix)
        id: run_agent
        env:
          USER_INPUT: ${{ github.event.client_payload.user_command || github.event.comment.body }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ZHIPU_API_KEY }}
        run: |
          npm install -g @anthropic-ai/claude-code
          
          echo "{}" > data/retrieve.json
          echo "ğŸ¤– Command: $USER_INPUT"
          
          # === Round 1: Claude æ‰§è¡Œ ===
          # æ³¨æ„ï¼šæˆ‘ä»¬ä¸å†åœ¨æ­¤å¤„ cp schedule.jsonï¼Œå› ä¸ºæˆ‘ä»¬ç”¨ last_sync_state.json åšåŸºå‡†
          claude -p "$USER_INPUT. \
          å¦‚æœæ˜¯æŸ¥è¯¢è¯·æ±‚ï¼Œå°†ç»“æœå†™å…¥ @data/retrieve.json ï¼›\
          å¦‚æœæ˜¯ä¿®æ”¹è¯·æ±‚ï¼Œä¿®æ”¹ @data/schedule.json å¹¶æ¸…ç©º retrieve.jsonã€‚\
          ä¸Šä¸‹æ–‡ï¼š@config/instructions.xml" --dangerously-skip-permissions

          # === Round 2: JSON è¯­æ³•æ£€æŸ¥ä¸è‡ªæ„ˆ (Lint & Fix) ===
          RETRIEVE_SIZE=$(wc -c < data/retrieve.json)
          if [ -s data/schedule.json ] && [ "$RETRIEVE_SIZE" -le 5 ]; then
             echo "ğŸ” Validating JSON syntax..."
             if ! python3 -m json.tool data/schedule.json > /dev/null 2>&1; then
                JSON_ERR=$(python3 -m json.tool data/schedule.json 2>&1 || true)
                echo "âš ï¸ JSON Broken. Triggering Auto-Fix... ($JSON_ERR)"
                
                claude -p "CRITICAL: The JSON you wrote is invalid. \
                Error: $JSON_ERR \
                Task: Fix data/schedule.json immediately. \
                Rule: strictly valid JSON, no trailing commas." \
                --dangerously-skip-permissions
                
                if ! python3 -m json.tool data/schedule.json > /dev/null; then
                   echo "âŒ FATAL: JSON still invalid after auto-fix."
                   cat data/schedule.json
                   exit 1
                fi
             fi
          fi

      - name: Check & Dispatch Result
        id: dispatcher
        env:
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          TARGET_ID: ${{ github.event.client_payload.user_id }}
        run: |
          RETRIEVE_CONTENT=$(cat data/retrieve.json)
          if echo "$RETRIEVE_CONTENT" | grep -q '"is_query": true'; then
            echo "ğŸ” Query Mode."
            MSG_CONTENT=$(cat data/retrieve.json)
            python3 scripts/feishu_bot.py msg "$TARGET_ID" "$MSG_CONTENT" "interactive" "LifeOps æŸ¥è¯¢ç»“æœ" "blue"
            echo "commit_needed=false" >> $GITHUB_OUTPUT
          else
            echo "âœï¸ Modification Mode."
            echo "commit_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Sync & Commit State
        if: steps.dispatcher.outputs.commit_needed == 'true'
        env:
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_USER_ID: ${{ secrets.FEISHU_USER_ID }}
          TARGET_ID: ${{ github.event.client_payload.user_id }}
        run: |
          git config --global user.name "LifeOps Bot"
          git config --global user.email "bot@lifeops.ai"
          
          # æ‰§è¡ŒåŒæ­¥ (è„šæœ¬å†…éƒ¨ä¼šæ›´æ–° last_sync_state.json)
          python3 scripts/feishu_bot.py diff_sync
          
          # ğŸŸ¢ å…³é”®ï¼šæäº¤æ‰€æœ‰å˜æ›´ï¼ŒåŒ…æ‹¬ schedule.json å’Œ last_sync_state.json
          # è¿™æ ·ä¸‹ä¸€æ¬¡ Action è¿è¡Œæ—¶ï¼Œå°±æœ‰äº†"è®°å¿†"
          git add .
          
          if [[ -n $(git status -s) ]]; then
            git commit -m "ğŸ¤– Schedule & State Updated"
            git push
            python3 scripts/feishu_bot.py msg "$TARGET_ID" "âœ… å˜æ›´å·²åŒæ­¥ (State Updated)ã€‚" "interactive" "æ“ä½œæˆåŠŸ" "green"
          else
            echo "No logic changes to commit."
            python3 scripts/feishu_bot.py msg "$TARGET_ID" "â„¹ï¸ æ— å®é™…å˜æ›´ã€‚" "text"
          fi
