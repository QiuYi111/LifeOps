name: LifeOps Secretary (Diff Mode)

on:
  repository_dispatch:
    types: [feishu_trigger]
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  manage_schedule:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialize Environment
        run: |
          mkdir -p ~/.claude
          cat <<EOF > ~/.claude/settings.json
          {
              "env": {
                  "ANTHROPIC_AUTH_TOKEN": "${{ secrets.ZHIPU_API_KEY }}",
                  "ANTHROPIC_BASE_URL": "https://open.bigmodel.cn/api/anthropic",
                  "API_TIMEOUT_MS": "3000000",
                  "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": "1"
              }
          }
          EOF
          mkdir -p data
          if [ ! -f data/schedule.json ]; then echo "[]" > data/schedule.json; fi
          chmod -R 777 data
          sudo timedatectl set-timezone Asia/Shanghai
          # ğŸŸ¢ å…³é”®ï¼šå®‰è£… Python ä¾èµ– (SDK)
          pip install -r requirements.txt
          echo "âœ… Environment ready."

      - name: Install & Run Claude Code
        id: run_agent
        env:
          USER_INPUT: ${{ github.event.client_payload.user_command || github.event.comment.body }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ZHIPU_API_KEY }}
        run: |
          npm install -g @anthropic-ai/claude-code
          
          # ğŸŸ¢ å…³é”®æ­¥éª¤ 1ï¼šåœ¨ Claude ä¿®æ”¹å‰ï¼Œå¤‡ä»½å½“å‰çŠ¶æ€
          cp data/schedule.json data/schedule.bak.json || echo "[]" > data/schedule.bak.json
          
          echo "{}" > data/retrieve.json
          echo "ğŸ¤– Command: $USER_INPUT"
          
          claude -p "$USER_INPUT. \
          å¦‚æœæ˜¯æŸ¥è¯¢è¯·æ±‚ï¼Œå°†ç»“æœå†™å…¥ @data/retrieve.json ï¼›\
          å¦‚æœæ˜¯ä¿®æ”¹è¯·æ±‚ï¼Œä¿®æ”¹ @data/schedule.json å¹¶æ¸…ç©º retrieve.jsonã€‚\
          ä¸Šä¸‹æ–‡ï¼š@config/instructions.xml" --dangerously-skip-permissions

      # --- åˆ†æ”¯ 1: æŸ¥è¯¢åé¦ˆ (ä¸å˜) ---
      - name: Check & Dispatch Result
        id: dispatcher
        env:
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          TARGET_ID: ${{ github.event.client_payload.user_id }}
        run: |
          RETRIEVE_CONTENT=$(cat data/retrieve.json)
          if echo "$RETRIEVE_CONTENT" | grep -q '"is_query": true'; then
            echo "ğŸ” Detected Query Mode."
            MSG_CONTENT=$(cat data/retrieve.json)
            python3 scripts/feishu_bot.py msg "$TARGET_ID" "$MSG_CONTENT" "interactive" "LifeOps æŸ¥è¯¢ç»“æœ" "blue"
            echo "commit_needed=false" >> $GITHUB_OUTPUT
          else
            echo "âœï¸ Detected Modification Mode."
            echo "commit_needed=true" >> $GITHUB_OUTPUT
          fi

      # --- åˆ†æ”¯ 2: Diff åŒæ­¥ & æäº¤ ---
      - name: Diff Sync & Commit
        if: steps.dispatcher.outputs.commit_needed == 'true'
        env:
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_USER_ID: ${{ secrets.FEISHU_USER_ID }}
          FEISHU_CALENDAR_ID: ${{ secrets.FEISHU_CALENDAR_ID }}
          TARGET_ID: ${{ github.event.client_payload.user_id }}
        run: |
          git config --global user.name "LifeOps Bot"
          git config --global user.email "bot@lifeops.ai"
          
          if [[ -n $(git status -s data/schedule.json) ]]; then
            # ğŸŸ¢ å…³é”®æ­¥éª¤ 2ï¼šå…ˆæ‰§è¡Œ Diff åŒæ­¥ (è¯»å– schedule.json å’Œ schedule.bak.json)
            python3 scripts/feishu_bot.py diff_sync
            
            # æäº¤ä»£ç 
            git add data/schedule.json
            git commit -m "ğŸ¤– Schedule Updated (Diff Applied)"
            git push
            
            # å‘é€æˆåŠŸé€šçŸ¥ (Diff è„šæœ¬å†…éƒ¨å…¶å®å·²ç»æ‰“å°äº†æ—¥å¿—ï¼Œè¿™é‡Œå‘ä¸ªæ€»ç¡®è®¤)
            python3 scripts/feishu_bot.py msg "$TARGET_ID" "âœ… å˜æ›´å·²åº”ç”¨åˆ°é£ä¹¦æ—¥å†ã€‚" "interactive" "æ“ä½œæˆåŠŸ" "green"
          else
            echo "No changes detected."
            python3 scripts/feishu_bot.py msg "$TARGET_ID" "â„¹ï¸ æ— éœ€ä¿®æ”¹æ—¥ç¨‹ã€‚" "text"
          fi
